<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="../Css/bootstrap3.min.css" rel="stylesheet" type="text/css" />
    <link href="../Css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="../Css/tsbs.css" rel="stylesheet" type="text/css" />
    <script src="../Js/jquery-latest.min.js" type="text/javascript"></script>
    <script src="../Js/bootstrap3.min.js" type="text/javascript"></script>
    <script src="../Js/typeahead.min.js" type="text/javascript"></script>
    <script src="../Js/handlebars.js"></script>

    <style type="text/css">
        html {
            padding-top: 54px;
        }

        body {
            background: #e8e8e8;
            color: #616161;
            text-align: center;
            overflow: auto;
        }

        .wrapper {
            height: 100%;
        }

        .board-container {
        }

        .board-column {
            display: table-cell;
            padding-left: 5px;
            border: 0px;
            padding: 0px;
            width: 330px;
            vertical-align: top;
        }

        .dropdown-menu {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .navbar {
            -webkit-box-shadow: 0px 4px 8px 0px rgba(0,0,0,0.28);
            -moz-box-shadow: 0px 4px 8px 0px rgba(0,0,0,0.28);
            box-shadow: 0px 4px 8px 0px rgba(0,0,0,0.28);
            background-color: #fff;
            border-color: #fff;
            height: 54px;
        }

        .ticket-card {
            background: #fff;
            color: #616161;
            border-radius: 2px;
            display: inline-block;
            margin: 1rem;
            position: relative;
            width: 300px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
            padding: 10px;
            font-size: 14px;
            text-align: left;
            border-left-width: 5px;
            border-left-style: solid;
        }

        .ticket-card-urgent {
            border-left-color: #F44336;
        }

        .ticket-card-high {
            border-left-color: #FF9800;
        }

        .ticket-card-normal {
            border-left-color: #4CAF50;
        }

        .ticket-card-low {
            border-left-color: #3276B1;
        }

        .ticket-card:hover {
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
        }

        .ticket-number {
            font-weight: bold;
            padding-right: 5px;
        }

        .user-avatar {
            margin-left: 10px;
            margin-bottom: 10px;
        }

        .ticket-stats {
            color: #777;
        }

        .ticket-name {
            padding-bottom: 10px;
            color:#111;
        }

        .status-name {
        }

        .ts-loading {
            background-color: transparent;
            background-image: url('../images/loading/ts-loading.gif');
            background-repeat: no-repeat;
            background-position: 50% 25%;
            height: 100%;
            min-height: 200px;
        }
    </style>

    <script language="javascript" type="text/javascript">
        $(document).ready(function () {
            var _statuses = null;

            function post(method, data, callback) {
                $.ajax({
                    type: "POST",
                    url: "/rt/Utils/TicketBoard/" + method,
                    data: JSON.stringify(data),
                    success: callback,
                    contentType: "application/json"
                });
            }

            post("GetBoardFilters", null, function (data) {
                var groups = data.Groups;
                var types = data.TicketTypes;
                var users = data.Users;
                var sticky = data.Sticky;

                if (!data.Sticky.GroupID) data.Sticky.GroupID = groups[0].GroupID;
                if (!data.Sticky.TicketTypeID) data.Sticky.TicketTypeID = types[0].TicketTypeID;
                if (!data.Sticky.UserID) data.Sticky.UserID = -1;


                var source = $("#action-template").html();

                var html = "";
                for (var i = 0; i < groups.length; i++) {
                    var item = { id: groups[i].GroupID, name: groups[i].Name, actionType: "group" };
                    html = html + Handlebars.compile(source)(item);
                    if (data.Sticky.GroupID && groups[i].GroupID == data.Sticky.GroupID) {
                        $('#menu-group a.dropdown-toggle').html(groups[i].Name + ' <span class="caret"></span>').data("id", groups[i].GroupID);
                    }
                }
                $('#menu-group ul').html(html);



                html = "";
                for (var i = 0; i < types.length; i++) {
                    var item = { id: types[i].TicketTypeID, name: types[i].Name, actionType: "type" };
                    html = html + Handlebars.compile(source)(item);
                    if (data.Sticky.TicketTypeID && types[i].TicketTypeID == data.Sticky.TicketTypeID) {
                        $('#menu-type a.dropdown-toggle').html(types[i].Name + ' <span class="caret"></span>').data("id", types[i].TicketTypeID);
                    }
                }
                $('#menu-type ul').html(html);

                html = "";
                users.unshift({ UserID: -1, UserName: "All Users" })

                for (var i = 0; i < users.length; i++) {
                    var item = { id: users[i].UserID, name: users[i].UserName, actionType: "user" };
                    html = html + Handlebars.compile(source)(item);
                    if (data.Sticky.UserID && users[i].UserID == data.Sticky.UserID) {
                        $('#menu-user a.dropdown-toggle').html(users[i].UserName + ' <span class="caret"></span>').data("id", users[i].UserID);
                    }
                }
                $('#menu-user ul').html(html);
                loading();
                post("GetTicketBoard", data.Sticky, loadTicketBoard);
            });


            function loadTicketBoard(data) {
                
                if (data == null) {
                    showStatuses();
                    return;
                }

                if (data != null) _statuses = data.Statuses;
                $('#board-container').html('');

                var columnHtml = "";
                var boxHtml = "";
                var source = $("#column-template").html();
                var boxSource = $("#status-box").html();
                
                for (var i = 0; i < _statuses.length; i++) {
                    boxHtml = boxHtml + Handlebars.compile(boxSource)(_statuses[i]);
                    if (_statuses[i].IsSelected)
                    {
                       _statuses[i].cards = buildCards(_statuses[i].ID, data.Board);
                        
                        columnHtml = columnHtml + Handlebars.compile(source)(_statuses[i]);
                       
                    }
                }
                $("#modal-statuses .modal-body").html(boxHtml);
               
                $("#board-container").html(columnHtml);
                unload();

                if (data.Board == null) $('#modal-statuses').modal('show');

            }

            function buildCards(id, board) {
                var source = $("#card-template").html();
                var html = "";
                for (var i = 0; i < board.length; i++) {
                    if (id == board[i].TicketStatusID) {
                        data = board[i];
                        data.Severity = data.Severity.toLowerCase();
                        if (data.UserID == null) data.UserID = -1;
                        if (data.Customers == '') data.Customers = "No Customers";
                        html = html + Handlebars.compile(source)(data);
                    }
                }
                
                if (html == "") {
                    html = '<div class="ticket-card card-empty}">There are no tickets!</div>';
                }
                return html;
            }

            function loading() {
                $('#board-container').html('').removeClass('ts-loading');

            }

            function unload() {
                $('#board-container').removeClass('ts-loading');
            }

            $('#save-statuses').click(function (e) {
                e.preventDefault();
                $('#modal-statuses').modal('hide');

                var data = [];
                $("#modal-statuses .status-setting input:checked").each(function () {
                    data.push($(this).data('id'));

                });

                var args = {};
                args.data = data;
                args.ticketTypeID = $('#menu-type .dropdown-toggle').data('id');
                args.groupID = $('#menu-group .dropdown-toggle').data('id');
                post("UpdateBoardSettings", args, function () {
                    getTicketBoard();
                });
                

            });

            function getTicketBoard() {
                loading();
                var data = {}
                data.groupID = $('#menu-group .dropdown-toggle').data('id');
                data.ticketTypeID = $('#menu-type .dropdown-toggle').data('id');
                data.userID = $('#menu-user .dropdown-toggle').data('id');

                post("GetTicketBoard", data, loadTicketBoard);

            }

            $(".dropdown").on("click", ".action", function () {
                $(this).closest('.dropdown').find('.dropdown-toggle').html($(this).text() + ' <span class="caret"></span>').data("id", $(this).data('id'));
                getTicketBoard();
            });
        });
    </script>

    <script id="action-template" type="text/x-handlebars-template">
        <li><a href="#" class="action action-{{actionType}}" data-id="{{id}}">{{name}}</a></li>
    </script>
    <script id="column-template" type="text/x-handlebars-template">
        <div class="board-column" data-id="{{ID}}">
            <div class="status-name"><h4>{{Name}}</h4></div>
            <div class="ticket-cards">
                {{{cards}}}
            </div>
        </div>
    </script>
    <script id="card-template" type="text/x-handlebars-template">
        <div class="ticket-card ticket-card-{{Severity}}">
           
            <div class="ticket-name">
                <img class="user-avatar pull-right" src="/dc/1078/UserAvatar/{{UserID}}/120"><a class="ticket-number" href="#">{{TicketNumber}}</a> {{Name}}</>
            </div>
            <div class="ticket-stats"><span>{{Customers}}</span> <span class="pull-right">CDI {{CDI}}</span></div>
            <div class="ticket-stats"><span>ARR {{ARR}}</span> <span class="pull-right">{{DaysIn}} Days in status</span></div>
        </div>
    </script>

    <script id="status-box" type="text/x-handlebars-template">
        <div class="checkbox status-setting">
            <label>
                <input type="checkbox" {{#if IsSelected}}checked{{^}}{{/if}} data-id="{{ID}}">
                {{Name}}
            </label>
        </div>


    </script>

</head>
<body>
    <div class="wrapper">
        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="container-fluid">
 
                    <div class="navbar-header">
                        <a class="navbar-brand" href="#">Ticket Board</a>
                    </div>

                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse">
                        <ul class="nav navbar-nav">
                            <li class="dropdown" id="menu-type">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"></a>
                                <ul class="dropdown-menu"></ul>
                            </li>
                            <li class="dropdown" id="menu-group">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"></a>
                                <ul class="dropdown-menu"></ul>
                            </li>
                            <li class="dropdown" id="menu-user">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"></a>
                                <ul class="dropdown-menu"></ul>
                            </li>
                        </ul>
                        <ul class="nav navbar-nav navbar-right">
                            <li><a href="#" data-toggle="modal" data-target="#modal-statuses"><i class="fa fa-2x fa-gear color-lightgray"></i></a></li>
                        </ul>
                    </div><!-- /.navbar-collapse -->
                </div><!-- /.container-fluid -->
            </div>
        </nav>

        <div class="container" id="ticket-board">
            <div id="board-container" class="ts-loading">


            </div>
        </div>
</div>
    <!-- Modal -->
    <div class="modal fade" id="modal-statuses" tabindex="-1" role="dialog" aria-labelledby="modalStatuses">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Pick some statuses</h4>
                </div>
                <div class="modal-body">
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" id="save-statuses" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
