<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">
  <link href="../Css/bootstrap3.min.css" rel="stylesheet" type="text/css" />
  <link href="../Css/font-awesome.min.css" rel="stylesheet" type="text/css" />
  <link href="../Css/tsbs.css" rel="stylesheet" type="text/css" />
  <!--[if IE]><link href="../Css/tsbs-ie.css" rel="stylesheet" type="text/css" /><![endif]-->
  <script src="../Js/jquery-latest.min.js" type="text/javascript"></script>
  <script src="../Js/bootstrap3.min.js" type="text/javascript"></script>
  <style type="text/css">
    body { background: #fff; padding-top: 15px;}
    .nav > li > a { padding: 2px 15px; }
    .report-valid a { color:Lime; font-weight: bold;}
    .report-bad a { color:Red; font-weight: bold;}
    .alert { display:none;}
  </style>

  <script language="javascript" type="text/javascript">
    $(document).ready(function () {
      top.Ts.Services.Reports.AdminGetReports(function (reports) {
        var list = $('.report-list');
        for (var i = 0; i < reports.length; i++) {
          if (reports[i].Query == null) continue;
          var item = $('<li>').data('report', reports[i]).attr('data-id', reports[i].ReportID);
          $('<a>')
            .attr('href', '#')
            .text(reports[i].ReportID + ' (' + (reports[i].OrganizationID ? reports[i].OrganizationID : 'Stock') + ')')
            .appendTo(item)
            .click(function (e) {
              e.preventDefault();
              loadReport($(this).closest('li'));
            });
          list.append(item);
        }

        loadReport($('.report-list li:first'));

      });

      function loadReport(li) {
        $('.report-list li').removeClass('active');
        var report = li.addClass('active').data('report');
        top.Ts.Services.Reports.AdminGetReport(report.ReportID, function (result) {
          li.data('report', result);
          $('.title').text(result.Name);
          $('#query').val(result.Query);
          if ($('#autotest').prop('checked')) $('.btn-test').trigger('click');
        });
      }

      $('.btn-save').click(function (e) {
        e.preventDefault();
        var report = $('.report-list li.active').data('report');
        top.Ts.Services.Reports.AdminUpdateQuery(report.ReportID, $('#query').val())
      });

      $('.btn-test').click(function (e) {
        e.preventDefault();
        var li = $('.report-list li.active');
        var report = li.data('report');
        top.Ts.Services.Reports.AdminTestQuery(report.ReportID, $('#query').val(),
        function () {
          li.addClass('report-valid').removeClass('report-bad');
          $('.alert-danger').hide();
          $('.alert-success').show();
        },
        function (response) {
          li.addClass('report-bad').removeClass('report-valid');
          $('.alert-success').hide();
          $('.message').html(response.get_message());
          $('.stack').html(response.get_stackTrace());
          $('.alert-danger').show();

        });
      });
    });  
  </script>

</head>
<body>
  <div class="frame-container container">
    <div class="row">
      <div class="col-xs-2">
        <ul class="nav nav-pills nav-stacked report-list">
        </ul>
      </div>
      <div class="col-xs-10">
      <form>
      <h3 class="title"></h3>
      <button class="btn-test btn btn-primary">Test</button>
      <button class="btn-save btn btn-default pull-right">Save</button>
      <div class="checkbox">
        <label>
          <input type="checkbox" id="autotest">
          Auto Test</label>
      </div>
      <div class="form-group">
        <label for="query">Query</label>
        <textarea id="query" class="form-control" rows="20"></textarea>
      </div>
      </form>
      <div class="alert alert-danger">
        <div><strong>Message: </strong><span class="message"></span></div>
        <div><strong>Stack Trace: </strong><p class="stack"></p></div>
      </div>
      <div class="alert alert-success">
        Successful!
      </div>
      </div>
    </div>
  </div>
</body>
</html>
